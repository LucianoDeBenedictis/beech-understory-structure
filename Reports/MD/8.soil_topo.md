---
title: "Gather soil and topography data"
author: "Luciano L.M. De Benedictis"
output: 
 pdf_document:
  latex_engine: xelatex
  keep_md: true
---


``` r
# setup -------------------------------------------------------------------

library(tidyverse)
```

```
## -- Attaching core tidyverse packages ------------------------ tidyverse 2.0.0 --
## v dplyr     1.1.4     v readr     2.1.6
## v forcats   1.0.1     v stringr   1.6.0
## v ggplot2   4.0.1     v tibble    3.3.0
## v lubridate 1.9.4     v tidyr     1.3.2
## v purrr     1.2.0     
## -- Conflicts ------------------------------------------ tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()
## i Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors
```

``` r
library(soilDB)
library(aqp)
```

```
## This is aqp 2.2-1
## 
## Attaching package: 'aqp'
## 
## The following objects are masked from 'package:dplyr':
## 
##     combine, slice
```

``` r
library(terra)
```

```
## terra 1.8.86
## 
## Attaching package: 'terra'
## 
## The following object is masked from 'package:tidyr':
## 
##     extract
```

``` r
points <- read_csv("map/coords.csv") |> 
  select(1:3) |> 
  rename(id = site, lat = Latitude, lon = Longitude)
```

```
## Rows: 28 Columns: 4
## -- Column specification --------------------------------------------------------
## Delimiter: ","
## chr (2): site, category
## dbl (2): Latitude, Longitude
## 
## i Use `spec()` to retrieve the full column specification for this data.
## i Specify the column types or set `show_col_types = FALSE` to quiet this message.
```

``` r
# soil --------------------------------------------------------------------
```

Downloading SoilGrids data takes time, uncomment to run and save data.


``` r
# soil <- fetchSoilGrids(points, verbose = T)
# 
# saveRDS(soil, "soilgrids.rds")

soil <- readRDS("soilgrids.rds")

summary <- horizons(soil) |> 
  select(label, id, nitrogenmean, phh2omean) |> 
  filter(label %in% c("0-5", "5-15", "15-30")) |> 
  group_by(id) |> 
  summarise(nitrogen = mean(nitrogenmean), ph = mean(phh2omean))

sites <- read_csv("data/classification.csv") |> 
  left_join(summary, by = join_by(site == id)) |> 
  drop_na()
```

```
## Rows: 32 Columns: 2
## -- Column specification --------------------------------------------------------
## Delimiter: ","
## chr (2): site, category
## 
## i Use `spec()` to retrieve the full column specification for this data.
## i Specify the column types or set `show_col_types = FALSE` to quiet this message.
```

``` r
sites |> 
  pivot_longer(c(nitrogen, ph), names_to = "variable", values_to = "value") |> 
  ggplot(aes(x = category, y = value, color = category))+
  #geom_boxplot()+
  geom_point(position = 'jitterdodge')+
  facet_wrap(~variable, scales = 'free_y')
```

![](8.soil_topo_files/figure-latex/unnamed-chunk-2-1.pdf)<!-- --> 

``` r
# topography --------------------------------------------------------------

dtm_casentino <- rast("map/DTM/w48570_s10/w48570_s10.tif")
plot(dtm_casentino)
```

![](8.soil_topo_files/figure-latex/unnamed-chunk-2-2.pdf)<!-- --> 

``` r
v <- vect(points, crs = "WGS84")
plot(v)
```

![](8.soil_topo_files/figure-latex/unnamed-chunk-2-3.pdf)<!-- --> 

``` r
WGS84 <- "+init=EPSG:4326"
dtm_casentino<- terra::project(dtm_casentino, WGS84) #reprojecting to epsg:4326#
plot(dtm_casentino)
points(v)
```

![](8.soil_topo_files/figure-latex/unnamed-chunk-2-4.pdf)<!-- --> 

``` r
slope <- terrain(dtm_casentino, v = "slope", unit = "degrees")
aspect <- terrain(dtm_casentino, v = "aspect", unit = "degrees")

altitude <- extract(dtm_casentino, v, ID=F, bind=T) |> 
  values() |> 
  rename(site = 1, altitude = 2)

slope <- extract(slope, v, ID=F, bind=T) |> 
  values() |> 
  rename(site = 1, slope = 2)

aspect <- extract(aspect, v, ID=F, bind=T) |> 
  values() |> 
  rename(site = 1, aspect = 2)

sites <- sites |> 
  left_join(altitude) |> 
  left_join(slope) |> 
  left_join(aspect)
```

```
## Joining with `by = join_by(site)`
## Joining with `by = join_by(site)`
## Joining with `by = join_by(site)`
```

``` r
print(sites, n = 50)
```

```
## # A tibble: 28 x 7
##    site  category    nitrogen    ph altitude slope aspect
##    <chr> <chr>          <dbl> <dbl>    <dbl> <dbl>  <dbl>
##  1 T1    Coppice         4.60  6.17     991.  18.0  302. 
##  2 T2    Coppice         4.60  6.17    1001.  21.5  305. 
##  3 T3    High Forest     5.29  6.17    1208.  14.7  283. 
##  4 T4    High Forest     5.32  6.13    1269.  20.0   47.3
##  5 T5    Old growth      5.66  6.03    1212.  29.9  212. 
##  6 T6    Old growth      5.52  6.13    1178.  36.4  203. 
##  7 T7    Old growth      5.75  5.9     1393.  26.0  105. 
##  8 T8    Old growth      5.71  5.97    1416.  26.3   96.5
##  9 T9    Old growth      5.76  5.97    1463.  35.4   74.4
## 10 T10   Coppice         5.42  6.13    1172.  24.9  187. 
## 11 T11   Coppice         5.42  6.13    1195.  23.8  190. 
## 12 T12   Old growth      5.90  5.97    1378.  30.4   79.1
## 13 T13   Old growth      5.90  5.97    1288.  25.1  117. 
## 14 T14   Old growth      5.90  5.97    1272.  25.5  105. 
## 15 T18   High Forest     5.39  5.9     1033.  14.2  115. 
## 16 T19   High Forest     5.39  5.9     1040.  13.0  105. 
## 17 T20   High Forest     5.39  5.9     1015.  14.4  124. 
## 18 T21   High Forest     5.23  5.9     1049.  24.0  344. 
## 19 T22   Coppice         5.23  5.9     1002.  23.9  359. 
## 20 T23   Coppice         5.23  5.9     1006.  22.9  272. 
## 21 T24   Coppice         5.38  6       1231.  22.5   47.9
## 22 T25   High Forest     5.45  5.8     1184.  17.4  227. 
## 23 T26   Coppice         5.36  5.97    1068.  10.6  292. 
## 24 T27   Coppice         5.24  6.13    1078.  34.4  120. 
## 25 T28   High Forest     5.39  5.9     1045.  16.3  121. 
## 26 T29   Old growth      5.90  5.93     962.  22.5  116. 
## 27 T30   Old growth      5.57  5.93     983.  24.7  157. 
## 28 T31   Old growth      5.39  5.87     923.  27.9   42.3
```

``` r
write_csv(sites, "other results/sitetype.csv")

# summary -----------------------------------------------------------------

library(circular)
```

```
## 
## Attaching package: 'circular'
## 
## The following objects are masked from 'package:stats':
## 
##     sd, var
```

``` r
summary <- sites |> 
  mutate(aspect = as.circular(aspect, units = "degrees", type = "angles",
                              template = "none", modulo = "2pi", zero = 0,
                              rotation = "clock")) |> 
  group_by(category) |> 
  summarise(across(c(nitrogen:slope), list(mean = mean, sd = sd)),
            aspect_mean = mean.circular(aspect),
            aspect_sd = sd.circular(aspect))

glimpse(summary)
```

```
## Rows: 3
## Columns: 11
## $ category      <chr> "Coppice", "High Forest", "Old growth"
## $ nitrogen_mean <dbl> 5.164444, 5.355000, 5.724242
## $ nitrogen_sd   <dbl> 0.32740563, 0.07138094, 0.17454125
## $ ph_mean       <dbl> 6.055556, 5.950000, 5.966667
## $ ph_sd         <dbl> 0.11303883, 0.12848321, 0.06992059
## $ altitude_mean <dbl> 1082.593, 1105.436, 1224.417
## $ altitude_sd   <dbl> 93.69086, 98.44995, 192.73518
## $ slope_mean    <dbl> 22.48391, 16.75765, 28.19986
## $ slope_sd      <dbl> 6.274834, 3.659278, 4.428776
## $ aspect_mean   <circular> 287.3575, 104.0401, 113.7978
## $ aspect_sd     <dbl> 1.6280338, 1.5571589, 0.8854249
```

``` r
write_csv(summary, "other results/sitesummary.csv")

# session info ------------------------------------------------------------

sessionInfo()
```

```
## R version 4.5.2 (2025-10-31)
## Platform: x86_64-redhat-linux-gnu
## Running under: Nobara Linux 43 (KDE Plasma Desktop Edition)
## 
## Matrix products: default
## BLAS/LAPACK: FlexiBLAS OPENBLAS-OPENMP;  LAPACK version 3.12.1
## 
## locale:
##  [1] LC_CTYPE=it_IT.UTF-8      LC_NUMERIC=C             
##  [3] LC_TIME=it_IT.utf8        LC_COLLATE=it_IT.UTF-8   
##  [5] LC_MONETARY=it_IT.utf8    LC_MESSAGES=it_IT.UTF-8  
##  [7] LC_PAPER=it_IT.utf8       LC_NAME=C                
##  [9] LC_ADDRESS=C              LC_TELEPHONE=C           
## [11] LC_MEASUREMENT=it_IT.utf8 LC_IDENTIFICATION=C      
## 
## time zone: Europe/Rome
## tzcode source: system (glibc)
## 
## attached base packages:
## [1] stats     graphics  grDevices datasets  utils     methods   base     
## 
## other attached packages:
##  [1] circular_0.5-2  terra_1.8-86    aqp_2.2-1       soilDB_2.8.13  
##  [5] lubridate_1.9.4 forcats_1.0.1   stringr_1.6.0   dplyr_1.1.4    
##  [9] purrr_1.2.0     readr_2.1.6     tidyr_1.3.2     tibble_3.3.0   
## [13] ggplot2_4.0.1   tidyverse_2.0.0
## 
## loaded via a namespace (and not attached):
##  [1] utf8_1.2.6         generics_0.1.4     stringi_1.8.7      lattice_0.22-7    
##  [5] hms_1.1.4          digest_0.6.39      magrittr_2.0.4     evaluate_1.0.5    
##  [9] grid_4.5.2         timechange_0.3.0   RColorBrewer_1.1-3 mvtnorm_1.3-3     
## [13] fastmap_1.2.0      ape_5.8-1          DBI_1.2.3          scales_1.4.0      
## [17] CoprManager_0.5.7  codetools_0.2-20   cli_3.6.5          crayon_1.5.3      
## [21] rlang_1.1.6        bit64_4.6.0-1      withr_3.0.2        yaml_2.3.12       
## [25] tools_4.5.2        parallel_4.5.2     tzdb_0.5.0         colorspace_2.1-2  
## [29] boot_1.3-32        curl_7.0.0         vctrs_0.6.5        R6_2.6.1          
## [33] lifecycle_1.0.4    bit_4.6.0          vroom_1.6.7        cluster_2.1.8.1   
## [37] pkgconfig_2.0.3    pillar_1.11.1      gtable_0.3.6       glue_1.8.0        
## [41] data.table_1.18.0  Rcpp_1.1.0         xfun_0.55          tidyselect_1.2.1  
## [45] rstudioapi_0.17.1  knitr_1.50         farver_2.1.2       htmltools_0.5.9   
## [49] nlme_3.1-168       labeling_0.4.3     rmarkdown_2.30     compiler_4.5.2    
## [53] S7_0.2.1
```



---
date: '2026-01-07'

---
